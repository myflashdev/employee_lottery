<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å“¡å·¥æŠ½çç³»çµ±</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [v-cloak] { display: none; }

    @keyframes slot-spin {
      0% { transform: translateY(0); }
      100% { transform: translateY(-100%); }
    }

    .spin-name {
      animation: slot-spin 0.1s linear infinite;
    }

    @keyframes winner-pop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); opacity: 1; }
    }

    .winner-reveal {
      animation: winner-pop 0.5s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti {
      position: fixed;
      top: -10px;
      width: 10px;
      height: 10px;
      z-index: 1000;
      pointer-events: none;
      animation: confetti-fall linear forwards;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
<div id="app" v-cloak>

  <!-- Confetti -->
  <div v-for="c in confetti" :key="c.id" class="confetti" :style="{
    left: c.x + '%',
    backgroundColor: c.color,
    animationDuration: c.duration + 's',
    width: c.size + 'px',
    height: c.size + 'px',
    borderRadius: c.round ? '50%' : '0',
  }"></div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-red-600 to-orange-500 text-white shadow-lg">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold text-center">ğŸ¯ å“¡å·¥æŠ½çç³»çµ±</h1>
      <p class="text-center text-red-100 mt-1">Employee Lottery System</p>
    </div>
  </header>

  <!-- Tab Navigation -->
  <div class="max-w-6xl mx-auto px-4 mt-6">
    <div class="flex space-x-1 bg-gray-200 rounded-lg p-1">
      <button v-for="tab in tabs" :key="tab.key"
        @click="currentTab = tab.key"
        :class="currentTab === tab.key
          ? 'bg-white text-gray-900 shadow'
          : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'"
        class="flex-1 py-2.5 px-4 rounded-md text-sm font-medium transition-all">
        {{ tab.label }}
      </button>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6">

    <!-- ==================== Tab 1: å“¡å·¥åå–® ==================== -->
    <div v-show="currentTab === 'employees'">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">æ–°å¢å“¡å·¥</h2>

          <!-- Manual Input -->
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">å“¡å·¥ç·¨è™Ÿ</label>
              <input v-model="newEmployee.id" type="text"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                placeholder="ä¾‹ï¼šEMP001" @keyup.enter="addEmployee">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">å“¡å·¥å§“å</label>
              <input v-model="newEmployee.name" type="text"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                placeholder="ä¾‹ï¼šç‹å°æ˜" @keyup.enter="addEmployee">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">éƒ¨é–€</label>
              <input v-model="newEmployee.dept" type="text"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                placeholder="ä¾‹ï¼šå·¥ç¨‹éƒ¨" @keyup.enter="addEmployee">
            </div>
            <button @click="addEmployee"
              class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition font-medium">
              æ–°å¢å“¡å·¥
            </button>
          </div>

          <!-- CSV Upload -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">æ‰¹æ¬¡åŒ¯å…¥ (CSV)</h3>
            <p class="text-xs text-gray-500 mb-3">æ ¼å¼ï¼šå“¡å·¥ç·¨è™Ÿ,å§“å,éƒ¨é–€ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</p>
            <label class="flex items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-red-400 hover:bg-red-50 transition">
              <div class="text-center">
                <p class="text-sm text-gray-600">é»æ“Šä¸Šå‚³ CSV æª”æ¡ˆ</p>
                <p class="text-xs text-gray-400 mt-1">æˆ–æ‹–æ”¾æª”æ¡ˆè‡³æ­¤</p>
              </div>
              <input type="file" accept=".csv,.txt" class="hidden" @change="importEmployeesCSV">
            </label>
          </div>

          <!-- Bulk Text Input -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">æ‰¹æ¬¡æ–‡å­—è¼¸å…¥</h3>
            <textarea v-model="bulkEmployeeText" rows="4"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent"
              placeholder="æ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šå“¡å·¥ç·¨è™Ÿ,å§“å,éƒ¨é–€&#10;EMP001,ç‹å°æ˜,å·¥ç¨‹éƒ¨&#10;EMP002,æå°è¯,è¡ŒéŠ·éƒ¨"></textarea>
            <button @click="importBulkEmployees"
              class="mt-2 w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 transition text-sm font-medium">
              æ‰¹æ¬¡æ–°å¢
            </button>
          </div>
        </div>

        <!-- Employee List -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">
              å“¡å·¥åå–®
              <span class="text-sm font-normal text-gray-500 ml-2">å…± {{ employees.length }} äºº</span>
            </h2>
            <div class="flex space-x-2">
              <button @click="exportEmployeesCSV"
                class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-200 transition"
                v-if="employees.length">åŒ¯å‡º</button>
              <button @click="clearEmployees"
                class="text-xs bg-red-100 text-red-700 px-3 py-1.5 rounded-md hover:bg-red-200 transition"
                v-if="employees.length">æ¸…ç©º</button>
            </div>
          </div>

          <div v-if="employees.length === 0" class="text-center py-12 text-gray-400">
            <p class="text-4xl mb-2">ğŸ“‹</p>
            <p>å°šç„¡å“¡å·¥è³‡æ–™</p>
            <p class="text-sm">è«‹å¾å·¦å´æ–°å¢æˆ–åŒ¯å…¥</p>
          </div>

          <div v-else class="overflow-y-auto max-h-[500px] space-y-2">
            <div v-for="(emp, idx) in employees" :key="emp.id"
              class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition group">
              <div>
                <span class="text-xs text-gray-400 mr-2">{{ emp.id }}</span>
                <span class="font-medium text-gray-800">{{ emp.name }}</span>
                <span class="text-xs text-gray-500 ml-2" v-if="emp.dept">{{ emp.dept }}</span>
              </div>
              <button @click="removeEmployee(idx)"
                class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition text-sm">
                âœ•
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Tab 2: çé …è¨­å®š ==================== -->
    <div v-show="currentTab === 'prizes'">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Prize Input -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">æ–°å¢çé …</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">çé …åç¨±</label>
              <input v-model="newPrize.name" type="text"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                placeholder="ä¾‹ï¼šé ­ç - iPhone 16" @keyup.enter="addPrize">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡</label>
              <input v-model.number="newPrize.quantity" type="number" min="1"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                placeholder="1" @keyup.enter="addPrize">
            </div>
            <button @click="addPrize"
              class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition font-medium">
              æ–°å¢çé …
            </button>
          </div>

          <!-- Bulk Prize Input -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">æ‰¹æ¬¡æ–‡å­—è¼¸å…¥</h3>
            <textarea v-model="bulkPrizeText" rows="4"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="æ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šçé …åç¨±,æ•¸é‡&#10;é ­ç - iPhone 16,1&#10;äºŒç - AirPods Pro,3&#10;ä¸‰ç - ç¦®åˆ¸500å…ƒ,10"></textarea>
            <button @click="importBulkPrizes"
              class="mt-2 w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 transition text-sm font-medium">
              æ‰¹æ¬¡æ–°å¢
            </button>
          </div>
        </div>

        <!-- Prize List -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">
              çé …æ¸…å–®
              <span class="text-sm font-normal text-gray-500 ml-2">å…± {{ totalPrizeCount }} å€‹çå“</span>
            </h2>
            <button @click="clearPrizes"
              class="text-xs bg-red-100 text-red-700 px-3 py-1.5 rounded-md hover:bg-red-200 transition"
              v-if="prizes.length">æ¸…ç©º</button>
          </div>

          <div v-if="prizes.length === 0" class="text-center py-12 text-gray-400">
            <p class="text-4xl mb-2">ğŸ</p>
            <p>å°šç„¡çé …</p>
            <p class="text-sm">è«‹å¾å·¦å´æ–°å¢çé …</p>
          </div>

          <div v-else class="space-y-2">
            <div v-for="(prize, idx) in prizes" :key="idx"
              class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition group"
              :class="prize.remaining > 0 ? 'bg-gray-50' : 'bg-green-50 opacity-60'">
              <div>
                <span class="font-medium text-gray-800">{{ prize.name }}</span>
                <span class="text-xs ml-2"
                  :class="prize.remaining > 0 ? 'text-orange-600' : 'text-green-600'">
                  å‰©é¤˜ {{ prize.remaining }} / {{ prize.quantity }}
                </span>
              </div>
              <button @click="removePrize(idx)"
                class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition text-sm">
                âœ•
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Tab 3: æŠ½ç ==================== -->
    <div v-show="currentTab === 'draw'">

      <!-- Status Bar -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm border p-4 text-center">
          <p class="text-2xl font-bold text-red-600">{{ availableEmployees.length }}</p>
          <p class="text-sm text-gray-500">å¯æŠ½å“¡å·¥</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border p-4 text-center">
          <p class="text-2xl font-bold text-orange-500">{{ totalRemainingPrizes }}</p>
          <p class="text-sm text-gray-500">å‰©é¤˜çå“</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border p-4 text-center">
          <p class="text-2xl font-bold text-green-600">{{ results.length }}</p>
          <p class="text-sm text-gray-500">å·²æŠ½å‡º</p>
        </div>
      </div>

      <!-- Draw Area -->
      <div class="bg-white rounded-xl shadow-sm border p-8">

        <!-- Prize Selector -->
        <div class="text-center mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡æŠ½ççé …</label>
          <select v-model="selectedPrizeIndex"
            class="border border-gray-300 rounded-lg px-4 py-2 text-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
            <option :value="-1" disabled>-- è«‹é¸æ“‡çé … --</option>
            <option v-for="(prize, idx) in prizes" :key="idx" :value="idx" :disabled="prize.remaining <= 0">
              {{ prize.name }} (å‰©é¤˜ {{ prize.remaining }})
            </option>
          </select>
        </div>

        <!-- Draw Count -->
        <div class="text-center mb-6" v-if="selectedPrize && selectedPrize.remaining > 1">
          <label class="block text-sm font-medium text-gray-700 mb-2">æœ¬æ¬¡æŠ½å‡ºäººæ•¸</label>
          <input v-model.number="drawCount" type="number" min="1" :max="maxDrawCount"
            class="border border-gray-300 rounded-lg px-4 py-2 text-lg text-center w-24 focus:ring-2 focus:ring-red-500 focus:border-transparent">
          <span class="text-sm text-gray-500 ml-2">ï¼ˆæœ€å¤š {{ maxDrawCount }} äººï¼‰</span>
        </div>

        <!-- Spinning Display -->
        <div class="text-center py-8">
          <div v-if="isSpinning" class="mb-4">
            <p class="text-gray-500 text-sm mb-2">æŠ½çä¸­...</p>
            <div class="inline-block bg-gradient-to-r from-red-500 to-orange-400 text-white text-4xl font-bold px-8 py-4 rounded-2xl shadow-lg">
              <span class="spin-name inline-block">{{ spinningName }}</span>
            </div>
          </div>

          <div v-else-if="lastWinners.length > 0" class="mb-4">
            <p class="text-gray-500 text-sm mb-2">ğŸ‰ æ­å–œä¸­çï¼</p>
            <div class="flex flex-wrap justify-center gap-3">
              <div v-for="w in lastWinners" :key="w.employee.id"
                class="winner-reveal bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-2xl font-bold px-6 py-3 rounded-2xl shadow-lg">
                {{ w.employee.name }}
              </div>
            </div>
          </div>

          <div v-else class="text-gray-400 py-4">
            <p class="text-6xl mb-3">ğŸ°</p>
            <p>é¸æ“‡çé …å¾Œé»æ“Šé–‹å§‹æŠ½ç</p>
          </div>
        </div>

        <!-- Draw Button -->
        <div class="text-center">
          <button @click="startDraw"
            :disabled="!canDraw"
            class="px-12 py-4 text-xl font-bold rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed disabled:transform-none"
            :class="isSpinning
              ? 'bg-gray-400 text-white'
              : 'bg-gradient-to-r from-red-600 to-orange-500 text-white hover:from-red-700 hover:to-orange-600'">
            {{ isSpinning ? 'æŠ½çä¸­...' : 'ğŸ² é–‹å§‹æŠ½ç' }}
          </button>
        </div>

        <!-- Cannot Draw Warnings -->
        <div class="text-center mt-4" v-if="!canDraw && !isSpinning">
          <p class="text-sm text-red-500" v-if="availableEmployees.length === 0">æ²’æœ‰å¯æŠ½çš„å“¡å·¥äº†</p>
          <p class="text-sm text-red-500" v-else-if="selectedPrizeIndex === -1">è«‹å…ˆé¸æ“‡çé …</p>
          <p class="text-sm text-red-500" v-else-if="selectedPrize && selectedPrize.remaining <= 0">æ­¤çé …å·²æŠ½å®Œ</p>
        </div>
      </div>
    </div>

    <!-- ==================== Tab 4: æŠ½ççµæœ ==================== -->
    <div v-show="currentTab === 'results'">
      <div class="bg-white rounded-xl shadow-sm border p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-800">
            æŠ½ççµæœ
            <span class="text-sm font-normal text-gray-500 ml-2">å…± {{ results.length }} ç­†</span>
          </h2>
          <div class="flex space-x-2">
            <button @click="exportResultsCSV"
              class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-200 transition"
              v-if="results.length">åŒ¯å‡º CSV</button>
            <button @click="clearResults"
              class="text-xs bg-red-100 text-red-700 px-3 py-1.5 rounded-md hover:bg-red-200 transition"
              v-if="results.length">æ¸…ç©ºçµæœ</button>
          </div>
        </div>

        <div v-if="results.length === 0" class="text-center py-12 text-gray-400">
          <p class="text-4xl mb-2">ğŸ“Š</p>
          <p>å°šç„¡æŠ½ççµæœ</p>
          <p class="text-sm">è«‹å‰å¾€ã€Œé–‹å§‹æŠ½çã€é€²è¡ŒæŠ½ç</p>
        </div>

        <div v-else>
          <!-- Group by Prize -->
          <div v-for="group in groupedResults" :key="group.prize" class="mb-6">
            <h3 class="text-md font-semibold text-orange-600 mb-2 flex items-center">
              ğŸ† {{ group.prize }}
              <span class="text-xs text-gray-500 ml-2">ï¼ˆ{{ group.winners.length }} åï¼‰</span>
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
              <div v-for="r in group.winners" :key="r.employee.id"
                class="flex items-center p-3 bg-orange-50 rounded-lg">
                <span class="text-xs text-gray-400 mr-2">{{ r.employee.id }}</span>
                <span class="font-medium text-gray-800">{{ r.employee.name }}</span>
                <span class="text-xs text-gray-500 ml-2" v-if="r.employee.dept">{{ r.employee.dept }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center py-6 text-gray-400 text-xs">
    å“¡å·¥æŠ½çç³»çµ± v1.0 â€” è³‡æ–™åƒ…å„²å­˜æ–¼ç€è¦½å™¨ LocalStorage
  </footer>

  <!-- Toast -->
  <div v-if="toast.show" class="fixed bottom-6 right-6 z-50 transition-all"
    :class="toast.type === 'error' ? 'bg-red-600' : toast.type === 'warning' ? 'bg-yellow-500' : 'bg-green-600'"
    class="text-white px-5 py-3 rounded-lg shadow-lg text-sm">
    {{ toast.message }}
  </div>
</div>

<script>
const { createApp, ref, computed, watch, onMounted, nextTick } = Vue

createApp({
  setup() {
    // ---- State ----
    const currentTab = ref('employees')
    const tabs = [
      { key: 'employees', label: 'ğŸ‘¥ å“¡å·¥åå–®' },
      { key: 'prizes', label: 'ğŸ çé …è¨­å®š' },
      { key: 'draw', label: 'ğŸ² é–‹å§‹æŠ½ç' },
      { key: 'results', label: 'ğŸ“Š æŠ½ççµæœ' },
    ]

    // Employees
    const employees = ref([])
    const newEmployee = ref({ id: '', name: '', dept: '' })
    const bulkEmployeeText = ref('')

    // Prizes
    const prizes = ref([])
    const newPrize = ref({ name: '', quantity: 1 })
    const bulkPrizeText = ref('')

    // Draw
    const selectedPrizeIndex = ref(-1)
    const drawCount = ref(1)
    const isSpinning = ref(false)
    const spinningName = ref('')
    const lastWinners = ref([])
    const results = ref([])
    const confetti = ref([])

    // Toast
    const toast = ref({ show: false, message: '', type: 'success' })
    let toastTimer = null

    function showToast(message, type = 'success') {
      toast.value = { show: true, message, type }
      clearTimeout(toastTimer)
      toastTimer = setTimeout(() => { toast.value.show = false }, 2500)
    }

    // ---- LocalStorage ----
    const STORAGE_KEY = 'employee-lottery-data'

    function saveData() {
      const data = {
        employees: employees.value,
        prizes: prizes.value,
        results: results.value,
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY)
        if (!raw) return
        const data = JSON.parse(raw)
        if (data.employees) employees.value = data.employees
        if (data.prizes) prizes.value = data.prizes
        if (data.results) results.value = data.results
      } catch (e) {
        console.warn('Failed to load saved data:', e)
      }
    }

    watch([employees, prizes, results], saveData, { deep: true })

    // ---- Employees ----
    function addEmployee() {
      const id = newEmployee.value.id.trim()
      const name = newEmployee.value.name.trim()
      if (!id || !name) {
        showToast('è«‹å¡«å¯«å“¡å·¥ç·¨è™Ÿèˆ‡å§“å', 'error')
        return
      }
      if (employees.value.some(e => e.id === id)) {
        showToast('å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨', 'error')
        return
      }
      employees.value.push({
        id,
        name,
        dept: newEmployee.value.dept.trim(),
      })
      newEmployee.value = { id: '', name: '', dept: '' }
      showToast(`å·²æ–°å¢ ${name}`)
    }

    function removeEmployee(idx) {
      employees.value.splice(idx, 1)
    }

    function clearEmployees() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å“¡å·¥è³‡æ–™å—ï¼Ÿ')) {
        employees.value = []
        showToast('å·²æ¸…ç©ºå“¡å·¥åå–®', 'warning')
      }
    }

    function parseCSVLine(line) {
      const parts = line.split(',').map(s => s.trim())
      if (parts.length >= 2) {
        return { id: parts[0], name: parts[1], dept: parts[2] || '' }
      }
      return null
    }

    function importEmployeesCSV(event) {
      const file = event.target.files[0]
      if (!file) return
      const reader = new FileReader()
      reader.onload = (e) => {
        const text = e.target.result
        const lines = text.split(/\r?\n/).filter(l => l.trim())
        let count = 0
        for (const line of lines) {
          // Skip header
          if (line.toLowerCase().includes('å“¡å·¥ç·¨è™Ÿ') || line.toLowerCase().includes('id')) continue
          const emp = parseCSVLine(line)
          if (emp && emp.id && emp.name && !employees.value.some(e => e.id === emp.id)) {
            employees.value.push(emp)
            count++
          }
        }
        showToast(`å·²åŒ¯å…¥ ${count} åå“¡å·¥`)
        event.target.value = ''
      }
      reader.readAsText(file)
    }

    function importBulkEmployees() {
      const lines = bulkEmployeeText.value.split(/\r?\n/).filter(l => l.trim())
      let count = 0
      for (const line of lines) {
        const emp = parseCSVLine(line)
        if (emp && emp.id && emp.name && !employees.value.some(e => e.id === emp.id)) {
          employees.value.push(emp)
          count++
        }
      }
      if (count > 0) {
        bulkEmployeeText.value = ''
        showToast(`å·²æ–°å¢ ${count} åå“¡å·¥`)
      } else {
        showToast('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™', 'error')
      }
    }

    function exportEmployeesCSV() {
      const header = 'å“¡å·¥ç·¨è™Ÿ,å§“å,éƒ¨é–€'
      const rows = employees.value.map(e => `${e.id},${e.name},${e.dept}`)
      downloadCSV([header, ...rows].join('\n'), 'employees.csv')
      showToast('å·²åŒ¯å‡ºå“¡å·¥åå–®')
    }

    // ---- Prizes ----
    const totalPrizeCount = computed(() => prizes.value.reduce((s, p) => s + p.quantity, 0))
    const totalRemainingPrizes = computed(() => prizes.value.reduce((s, p) => s + p.remaining, 0))
    const selectedPrize = computed(() => selectedPrizeIndex.value >= 0 ? prizes.value[selectedPrizeIndex.value] : null)

    function addPrize() {
      const name = newPrize.value.name.trim()
      const qty = newPrize.value.quantity || 1
      if (!name) {
        showToast('è«‹å¡«å¯«çé …åç¨±', 'error')
        return
      }
      prizes.value.push({ name, quantity: qty, remaining: qty })
      newPrize.value = { name: '', quantity: 1 }
      showToast(`å·²æ–°å¢çé …ï¼š${name}`)
    }

    function removePrize(idx) {
      prizes.value.splice(idx, 1)
    }

    function clearPrizes() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰çé …å—ï¼Ÿ')) {
        prizes.value = []
        showToast('å·²æ¸…ç©ºçé …', 'warning')
      }
    }

    function importBulkPrizes() {
      const lines = bulkPrizeText.value.split(/\r?\n/).filter(l => l.trim())
      let count = 0
      for (const line of lines) {
        const parts = line.split(',').map(s => s.trim())
        if (parts.length >= 1 && parts[0]) {
          const name = parts[0]
          const qty = parseInt(parts[1]) || 1
          prizes.value.push({ name, quantity: qty, remaining: qty })
          count++
        }
      }
      if (count > 0) {
        bulkPrizeText.value = ''
        showToast(`å·²æ–°å¢ ${count} å€‹çé …`)
      } else {
        showToast('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™', 'error')
      }
    }

    // ---- Draw ----
    const wonEmployeeIds = computed(() => new Set(results.value.map(r => r.employee.id)))
    const availableEmployees = computed(() => employees.value.filter(e => !wonEmployeeIds.value.has(e.id)))
    const maxDrawCount = computed(() => {
      if (!selectedPrize.value) return 1
      return Math.min(selectedPrize.value.remaining, availableEmployees.value.length)
    })
    const canDraw = computed(() =>
      !isSpinning.value &&
      selectedPrizeIndex.value >= 0 &&
      selectedPrize.value &&
      selectedPrize.value.remaining > 0 &&
      availableEmployees.value.length > 0
    )

    watch(maxDrawCount, (val) => {
      if (drawCount.value > val) drawCount.value = val
      if (drawCount.value < 1) drawCount.value = 1
    })

    function startDraw() {
      if (!canDraw.value) return

      isSpinning.value = true
      lastWinners.value = []
      const count = Math.min(drawCount.value || 1, maxDrawCount.value)

      // Spinning animation
      const pool = [...availableEmployees.value]
      let spinInterval = setInterval(() => {
        spinningName.value = pool[Math.floor(Math.random() * pool.length)].name
      }, 60)

      // Stop after 2 seconds
      setTimeout(() => {
        clearInterval(spinInterval)

        // Pick random winners
        const winners = []
        const poolCopy = [...availableEmployees.value]
        for (let i = 0; i < count; i++) {
          if (poolCopy.length === 0) break
          const idx = Math.floor(Math.random() * poolCopy.length)
          const winner = poolCopy.splice(idx, 1)[0]
          winners.push({
            prize: selectedPrize.value.name,
            employee: { ...winner },
            time: new Date().toLocaleString('zh-TW'),
          })
        }

        // Update state
        for (const w of winners) {
          results.value.push(w)
        }
        selectedPrize.value.remaining -= winners.length

        lastWinners.value = winners
        isSpinning.value = false
        spinningName.value = ''

        // Confetti!
        launchConfetti()
      }, 2000)
    }

    function launchConfetti() {
      const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899']
      const pieces = []
      for (let i = 0; i < 50; i++) {
        pieces.push({
          id: Date.now() + i,
          x: Math.random() * 100,
          color: colors[Math.floor(Math.random() * colors.length)],
          duration: 1.5 + Math.random() * 2,
          size: 6 + Math.random() * 8,
          round: Math.random() > 0.5,
        })
      }
      confetti.value = pieces
      setTimeout(() => { confetti.value = [] }, 4000)
    }

    // ---- Results ----
    const groupedResults = computed(() => {
      const map = {}
      for (const r of results.value) {
        if (!map[r.prize]) map[r.prize] = { prize: r.prize, winners: [] }
        map[r.prize].winners.push(r)
      }
      return Object.values(map)
    })

    function clearResults() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æŠ½ççµæœå—ï¼Ÿé€™å°‡é‡ç½®æ‰€æœ‰çé …çš„å‰©é¤˜æ•¸é‡ã€‚')) {
        results.value = []
        prizes.value.forEach(p => { p.remaining = p.quantity })
        lastWinners.value = []
        showToast('å·²æ¸…ç©ºæŠ½ççµæœ', 'warning')
      }
    }

    function exportResultsCSV() {
      const header = 'çé …,å“¡å·¥ç·¨è™Ÿ,å§“å,éƒ¨é–€,æŠ½çæ™‚é–“'
      const rows = results.value.map(r =>
        `${r.prize},${r.employee.id},${r.employee.name},${r.employee.dept},${r.time}`
      )
      downloadCSV([header, ...rows].join('\n'), 'lottery-results.csv')
      showToast('å·²åŒ¯å‡ºæŠ½ççµæœ')
    }

    // ---- Utility ----
    function downloadCSV(content, filename) {
      const BOM = '\uFEFF'
      const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = filename
      a.click()
      URL.revokeObjectURL(url)
    }

    // ---- Init ----
    onMounted(() => {
      loadData()
    })

    return {
      currentTab, tabs,
      employees, newEmployee, bulkEmployeeText,
      addEmployee, removeEmployee, clearEmployees, importEmployeesCSV, importBulkEmployees, exportEmployeesCSV,
      prizes, newPrize, bulkPrizeText, totalPrizeCount, totalRemainingPrizes,
      addPrize, removePrize, clearPrizes, importBulkPrizes,
      selectedPrizeIndex, selectedPrize, drawCount, maxDrawCount,
      isSpinning, spinningName, lastWinners, canDraw, startDraw,
      availableEmployees, confetti,
      results, groupedResults, clearResults, exportResultsCSV,
      toast,
    }
  }
}).mount('#app')
</script>
</body>
</html>
